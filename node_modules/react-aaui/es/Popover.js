import _slicedToArray from 'babel-runtime/helpers/slicedToArray';
import _defineProperty from 'babel-runtime/helpers/defineProperty';
import _extends from 'babel-runtime/helpers/extends';
import _objectWithoutProperties from 'babel-runtime/helpers/objectWithoutProperties';
import _Object$getPrototypeOf from 'babel-runtime/core-js/object/get-prototype-of';
import _classCallCheck from 'babel-runtime/helpers/classCallCheck';
import _createClass from 'babel-runtime/helpers/createClass';
import _possibleConstructorReturn from 'babel-runtime/helpers/possibleConstructorReturn';
import _inherits from 'babel-runtime/helpers/inherits';
import React, { Component, Fragment } from 'react';
import ReactDOM, { findDOMNode, render } from 'react-dom';
import { string, object, node, oneOf } from 'prop-types';
import classNames from 'classnames';
import './Popover.less';

var HIDDEN_POSITION = { left: '-2000px', top: '-2000px' };

var propTypes = {
  className: string,
  style: object,
  direction: oneOf(['n', 'ne', 'e', 'se', 's', 'sw', 'w', 'nw']).isRequired,
  theme: oneOf(['', 'dark', 'light']),
  children: node,
  ariaLabelText: string
};

var defaultProps = {
  direction: 'e',
  theme: 'light',
  ariaLabelText: undefined
};

var triggerStyle = {
  position: 'absolute',
  top: 0,
  right: 0,
  bottom: 0,
  left: 0,
  zIndex: 9
};

var getPopoverPosition = function getPopoverPosition(_ref) {
  var top = _ref.top,
      right = _ref.right,
      bottom = _ref.bottom,
      left = _ref.left,
      scrollX = _ref.scrollX,
      scrollY = _ref.scrollY,
      direction = _ref.direction;

  var halfWidth = (right - left) / 2;
  var halfHeight = (bottom - top) / 2;
  var arrowHeight = 12;
  var arrowWidth = 30;
  var sTop = function sTop() {
    return bottom + arrowHeight + 'px';
  };
  var nTop = function nTop() {
    return scrollY + top - arrowHeight + 'px';
  };
  var nsLeft = function nsLeft() {
    return scrollX + left + halfWidth + 'px';
  };
  var ewTop = function ewTop() {
    return scrollY + top + halfHeight + 'px';
  };
  var sneLeft = function sneLeft() {
    return scrollX + left + halfWidth - arrowWidth + 'px';
  };
  var nswLeft = function nswLeft() {
    return scrollX + left + halfWidth + arrowWidth + 'px';
  };
  var eLeft = function eLeft() {
    return scrollX + right + arrowHeight + 'px';
  };
  var wLeft = function wLeft() {
    return scrollX + left - arrowHeight + 'px';
  };

  var positions = {
    n: function n() {
      return { left: nsLeft(), top: nTop() };
    },
    ne: function ne() {
      return { left: sneLeft(), top: nTop() };
    },
    e: function e() {
      return { left: eLeft(), top: ewTop() };
    },
    se: function se() {
      return { left: sneLeft(), top: sTop() };
    },
    s: function s() {
      return { left: nsLeft(), top: sTop() };
    },
    sw: function sw() {
      return { left: nswLeft(), top: sTop() };
    },
    w: function w() {
      return { left: wLeft(), top: ewTop() };
    },
    nw: function nw() {
      return { left: nswLeft(), top: nTop() };
    }
  };

  return positions[direction]();
};

var isElementInViewport = function isElementInViewport(_ref2) {
  var t = _ref2.top,
      l = _ref2.left,
      width = _ref2.width,
      height = _ref2.height;
  var _window = window,
      pageXOffset = _window.pageXOffset,
      pageYOffset = _window.pageYOffset,
      innerWidth = _window.innerWidth,
      innerHeight = _window.innerHeight;

  var top = t - pageYOffset;
  var left = l - pageXOffset;
  var bottom = pageYOffset + innerHeight - (top + height);
  var right = pageXOffset + innerWidth - (left + width);

  return top > 0 && left > 0 && bottom > 0 && right > 0;
};

var Popover = function (_Component) {
  _inherits(Popover, _Component);

  function Popover(props) {
    _classCallCheck(this, Popover);

    var _this = _possibleConstructorReturn(this, (Popover.__proto__ || _Object$getPrototypeOf(Popover)).call(this, props));

    _this.onMouseEnter = function () {
      _this.clearTimer();
      _this.setState({ show: true });
    };

    _this.onMouseEnterPopover = function () {
      _this.clearTimer();
    };

    _this.onMouseLeave = function () {
      _this.hidePopover();
    };

    _this.setPopoverDimension = function () {
      var _this$props = _this.props,
          className = _this$props.className,
          style = _this$props.style,
          direction = _this$props.direction,
          theme = _this$props.theme,
          children = _this$props.children,
          rest = _objectWithoutProperties(_this$props, ['className', 'style', 'direction', 'theme', 'children']);

      var renderContainer = document.createElement('div');
      var classes = _this.getClasses({ direction: direction, theme: theme, className: className });
      var positionStyle = HIDDEN_POSITION;
      var popover = _this.getPopover({
        classes: classes, style: style, positionStyle: positionStyle, children: children, rest: rest
      });

      _this.el.appendChild(renderContainer);

      render(popover, renderContainer, function () {
        var renderedPopover = findDOMNode(renderContainer.firstChild);
        var offsetHeight = renderedPopover.offsetHeight,
            offsetWidth = renderedPopover.offsetWidth;


        _this.setState({
          popoverHeight: offsetHeight,
          popoverWidth: offsetWidth
        });
        _this.el.removeChild(renderContainer);
      });
    };

    _this.getPopoverPositionStyle = function (direction) {
      if (!_this.state.show) {
        return {};
      }

      var _this$trigger$getBoun = _this.trigger.getBoundingClientRect(),
          top = _this$trigger$getBoun.top,
          right = _this$trigger$getBoun.right,
          bottom = _this$trigger$getBoun.bottom,
          left = _this$trigger$getBoun.left;

      var _window2 = window,
          scrollX = _window2.pageXOffset,
          scrollY = _window2.pageYOffset;

      var position = getPopoverPosition({
        top: top,
        right: right,
        bottom: bottom,
        left: left,
        scrollX: scrollX,
        scrollY: scrollY,
        direction: direction
      });

      return position;
    };

    _this.clearTimer = function () {
      if (_this.timer) {
        window.clearTimeout(_this.timer);
      }
    };

    _this.hidePopover = function () {
      _this.clearTimer();
      _this.timer = window.setTimeout(function () {
        _this.setState({ show: false });
      }, 100);
    };

    _this.getPopover = function (_ref3) {
      var classes = _ref3.classes,
          style = _ref3.style,
          positionStyle = _ref3.positionStyle,
          children = _ref3.children,
          rest = _ref3.rest;

      return React.createElement(
        'div',
        _extends({ className: classes,
          style: _extends({}, style, positionStyle),
          onMouseEnter: _this.onMouseEnterPopover,
          onMouseLeave: _this.onMouseLeave
        }, rest),
        children
      );
    };

    _this.getClasses = function (_ref4) {
      var _classNames;

      var direction = _ref4.direction,
          theme = _ref4.theme,
          className = _ref4.className;
      return classNames((_classNames = {
        popover: true,
        'popover--wrapped': true
      }, _defineProperty(_classNames, 'popover--' + direction, direction), _defineProperty(_classNames, 't-' + theme, theme), _classNames), className);
    };

    _this.getDirection = function () {
      var direction = _this.props.direction;
      var _this$state = _this.state,
          show = _this$state.show,
          popoverHeight = _this$state.popoverHeight,
          popoverWidth = _this$state.popoverWidth;

      var regulatePosition = function regulatePosition(_ref5) {
        var t = _ref5.top,
            l = _ref5.left,
            d = _ref5.direction,
            w = _ref5.width,
            h = _ref5.height;

        switch (d) {
          case 'n':
            return { top: t - h, left: l - w / 2 };
          case 'ne':
            return { top: t - h, left: l };
          case 'e':
            return { top: t - h / 2, left: l };
          case 'se':
            return { top: t, left: l };
          case 's':
            return { top: t - h / 2, left: l - w / 2 };
          case 'sw':
            return { top: t - h, left: l - w };
          case 'w':
            return { top: t - h / 2, left: l - w };
          case 'nw':
            return { top: t - h, left: l - w };
          default:
            return { top: t, left: l };
        }
      };
      var popoverInViewport = function popoverInViewport(dir) {
        var _this$getPopoverPosit = _this.getPopoverPositionStyle(dir),
            top = _this$getPopoverPosit.top,
            left = _this$getPopoverPosit.left;

        var _regulatePosition = regulatePosition({
          top: parseInt(top, 10),
          left: parseInt(left, 10),
          height: popoverHeight,
          width: popoverWidth,
          direction: dir
        }),
            t = _regulatePosition.top,
            l = _regulatePosition.left;

        return isElementInViewport({
          top: t,
          left: l,
          height: popoverHeight,
          width: popoverWidth
        });
      };

      if (!(show && popoverHeight && popoverWidth)) {
        return direction;
      }

      if (popoverInViewport(direction)) {
        return direction;
      }

      var orderedDirection = ['n', 'ne', 'e', 'se', 's', 'sw', 'w', 'nw'];
      var index = orderedDirection.indexOf(direction);
      var traverseDirection = orderedDirection.slice(index + 1).concat(orderedDirection.slice(0, index));

      while (traverseDirection.length > 0) {
        var d = traverseDirection.shift();
        if (popoverInViewport(d)) {
          return d;
        }
      }

      return direction;
    };

    _this.showPopover = function () {
      var _this$props2 = _this.props,
          className = _this$props2.className,
          style = _this$props2.style,
          theme = _this$props2.theme,
          children = _this$props2.children,
          rest = _objectWithoutProperties(_this$props2, ['className', 'style', 'theme', 'children']);

      var direction = _this.getDirection();
      var classes = _this.getClasses({ direction: direction, theme: theme, className: className });
      var positionStyle = _this.getPopoverPositionStyle(direction);
      var popover = _this.getPopover({
        classes: classes, style: style, positionStyle: positionStyle, children: children, rest: rest
      });
      return ReactDOM.createPortal(popover, _this.el);
    };

    _this.trigger = null;
    _this.setTriggerRef = function (element) {
      _this.trigger = element;
    };
    _this.state = { show: false };
    return _this;
  }

  _createClass(Popover, [{
    key: 'componentDidMount',
    value: function componentDidMount() {
      var containerClass = 'aaui-popover-container';
      var existingContainer = document.getElementsByClassName(containerClass);

      if (existingContainer.length > 0) {
        var _existingContainer = _slicedToArray(existingContainer, 1);

        this.el = _existingContainer[0];
      } else {
        this.el = document.createElement('div');
        this.el.setAttribute('class', containerClass);
        document.body.appendChild(this.el);
      }
      this.setPopoverDimension();
    }
  }, {
    key: 'componentWillUnmount',
    value: function componentWillUnmount() {
      this.clearTimer();
    }
  }, {
    key: 'render',
    value: function render() {
      var show = this.state.show;
      var ariaLabelText = this.props.ariaLabelText;

      return React.createElement(
        Fragment,
        null,
        React.createElement('div', {
          tabIndex: 0,
          onMouseEnter: this.onMouseEnter,
          onMouseLeave: this.onMouseLeave,
          onFocus: this.onMouseEnter,
          onBlur: this.onMouseLeave,
          ref: this.setTriggerRef,
          'aria-label': ariaLabelText,
          style: triggerStyle }),
        show && this.showPopover()
      );
    }
  }]);

  return Popover;
}(Component);

Popover.displayName = 'AUIPopover';
Popover.propTypes = propTypes;
Popover.defaultProps = defaultProps;

export default Popover;