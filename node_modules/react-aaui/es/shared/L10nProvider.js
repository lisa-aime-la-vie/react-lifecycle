import _extends from 'babel-runtime/helpers/extends';
import _Promise from 'babel-runtime/core-js/promise';
import _defineProperty from 'babel-runtime/helpers/defineProperty';
import _Object$getPrototypeOf from 'babel-runtime/core-js/object/get-prototype-of';
import _classCallCheck from 'babel-runtime/helpers/classCallCheck';
import _createClass from 'babel-runtime/helpers/createClass';
import _possibleConstructorReturn from 'babel-runtime/helpers/possibleConstructorReturn';
import _inherits from 'babel-runtime/helpers/inherits';
import { PureComponent, Children } from 'react';
import { string, object, node, func } from 'prop-types';
import L10n from './L10n';
import { aauiL10nShape } from './types';

var l10nName = 'aauiL10n';

var L10nProvider = function (_PureComponent) {
  _inherits(L10nProvider, _PureComponent);

  function L10nProvider(props, context) {
    _classCallCheck(this, L10nProvider);

    var _this = _possibleConstructorReturn(this, (L10nProvider.__proto__ || _Object$getPrototypeOf(L10nProvider)).call(this, props, context));

    _this.state = { messages: props.messages || {} };
    _this.l10n = props.l10n || new L10n(props, context);
    return _this;
  }

  _createClass(L10nProvider, [{
    key: 'getChildContext',
    value: function getChildContext() {
      return _defineProperty({}, l10nName, this.l10n);
    }
  }, {
    key: 'componentDidMount',
    value: function componentDidMount() {
      var _this2 = this;

      var modules = [import( /* webpackChunkName: "AUI/L10n/[request]" */
      '../../i18n/' + this.props.locale + '.json')];

      if (typeof this.props.resolveMessage === 'function') {
        modules.push(this.props.resolveMessage(this.props.locale));
      }

      _Promise.all(modules).then(function (messages) {
        _this2.syncMessages(_extends({}, messages[0], messages[1]));
      });
    }
  }, {
    key: 'componentWillReceiveProps',
    value: function componentWillReceiveProps(nextProps) {
      var _this3 = this;

      if (this.props.locale !== nextProps.locale) {
        this.l10n.locale = nextProps.locale;

        var modules = [import( /* webpackChunkName: "AUI/L10n/[request]" */
        '../../i18n/' + this.l10n.locale + '.json')];

        if (typeof nextProps.resolveMessage === 'function') {
          modules.push(nextProps.resolveMessage(this.l10n.locale));
        }

        _Promise.all(modules).then(function (messages) {
          _this3.syncMessages(_extends({}, messages[0], messages[1]));
        });
      }

      if (this.props.messages !== nextProps.messages) {
        this.syncMessages(nextProps.messages);
      }
    }
  }, {
    key: 'syncMessages',
    value: function syncMessages(messages) {
      this.l10n.messages = _extends({}, this.l10n.messages, messages);

      this.setState({
        messages: this.l10n.messages
      });
    }
  }, {
    key: 'render',
    value: function render() {
      return Children.only(this.props.children);
    }
  }]);

  return L10nProvider;
}(PureComponent);

L10nProvider.propTypes = {
  locale: string,
  messages: object, // eslint-disable-line
  l10n: object, // eslint-disable-line
  resolveMessage: func,
  children: node
};
L10nProvider.defaultProps = {
  locale: 'en_US'
};
L10nProvider.childContextTypes = _defineProperty({}, l10nName, aauiL10nShape);
export default L10nProvider;